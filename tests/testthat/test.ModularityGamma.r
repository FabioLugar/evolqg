test_that("ModularityGamma returns correct results",{
 skip_on_cran()
 expected = structure(list(.id = c("a_b_c", "a_b_c_f", "a_b_c_d", "a_b_c_d_f", 
 "a_b_c_e", "a_b", "a_c", "b_c", "a_b_c_e_f", "a_b_f", "a_c_f", 
 "a_c_g", "a_c_d", "b_c_d", "b_c_f", "a_c_f_g", "a_b_c_d_e", "a_b_c_d_e_f", 
 "a_c_d_f", "a_b_e", "b_c_d_f", "a_c_e", "a_c_d_g", "a_b_e_f", 
 "b_c_d_e", "a_c_e_f", "a_c_d_f_g", "b_c_d_e_f", "a_g", "c_d", 
 "a_f_g", "a_b_d_e", "c_d_g", "a_b_d", "a_c_d_e", "a_b_d_e_f", 
 "b_c_e", "c_d_f_g", "a_b_d_f", "a_c_d_e_f", "a_e", "c_d_f", "b_c_e_f", 
 "a_d_g", "b_d_e", "a_e_f", "a_d_f_g", "c_g", "c_d_e", "b_d_e_f", 
 "c_d_e_f", "c_f_g", "a", "a_f", "b", "d_g", "a_d_e", "c", "b_e", 
 "a_d", "b_d", "d_f_g", "a_d_e_f", "b_f", "c_e", "a_d_f", "b_d_f", 
 "c_f", "b_e_f", "c_e_f", "g", "d_e", "d_e_f", "f_g", "e", "d", 
 "d_f", "e_f", "f"), corrected.gamma = c(3.83391012760194, 5.69697830205288, 
 11.3178569311034, 12.6647780582375, 12.9853259624412, 13.273483779476, 
 13.7421251924801, 13.8620464366687, 13.954613496729, 14.1594120965514, 
 14.7416240524688, 14.7974037653607, 15.4080179442322, 15.439519000727, 
 15.7251146111197, 15.7666912996485, 15.8343276675899, 16.2874681545607, 
 16.7549390713662, 16.7812525206027, 16.7864401278611, 17.0754869755699, 
 17.6464054705093, 17.7505400548905, 17.9362220012404, 18.0447745098577, 
 18.0995459574802, 18.3893624882112, 18.5933303235221, 19.5296800138558, 
 19.5626178578099, 19.6302542257513, 19.7482998041598, 19.8509867883921, 
 19.9244886807186, 20.0833947127222, 20.1338159612322, 20.2014402911307, 
 20.2207680581506, 20.3776291676894, 20.8714135337314, 20.8766011409898, 
 21.1031034955199, 21.4423320286708, 21.7321485594018, 21.8407010680192, 
 21.8954725156416, 21.9458937641516, 22.0263830143691, 22.1852890463727, 
 22.47952350134, 22.9151812984394, 23.1816988443542, 23.2040578469674, 
 23.3016200885428, 23.5442263623213, 23.72041523888, 23.7702615015469, 
 23.9297425193936, 23.9411478015208, 23.9726488580157, 23.9973668492922, 
 24.1735557258509, 24.1875484056182, 24.2239769743609, 24.3109290712793, 
 24.3424301277742, 24.7697603615356, 24.8990300536814, 25.1932645086486, 
 25.7418203223131, 25.8223095725305, 26.2754500595014, 26.7111078566008, 
 28.0199035325223, 28.0628098711444, 28.4325911409029, 28.9891910668101, 
 33.2321941560341), 
 raw.gamma = c(18.5160215421212, 16.5352229336492, 
 10.6245012139306, 9.08852225387238, 8.44810346234538, 32.7604286726491, 
 33.2290700856532, 33.3489913298418, 7.49545760517164, 29.3220068589361, 
 29.9042188148535, 6.89679783020718, 16.6365956185208, 16.6680966750157, 
 31.3681927213697, 5.94415197303345, 5.53130499310945, 5.02347878434956, 
 15.1006166584626, 14.1659634119683, 15.1321177149575, 14.4601978669356, 
 3.97999936097126, 13.2133175547946, 8.59416602249074, 13.5075520097619, 
 3.47217315221137, 8.08633981373085, 12.6146577798301, 22.680191079606, 
 11.6620119226564, 11.2491649427324, 7.04286039035254, 23.4819812020077, 
 11.5433993976997, 10.7413387339725, 18.9599768961939, 6.53503418159265, 
 20.4883790367085, 11.0355731889398, 20.1780578165586, 21.1442121195477, 
 18.0073310390202, 9.69785931059422, 14.3120259721137, 19.2254119593848, 
 9.19003310183433, 17.4086712640558, 14.606260427081, 13.8041997633538, 
 14.0984342183211, 16.456025406882, 47.473477216181, 42.6910027401404, 
 47.5933984603697, 12.7607203399755, 17.2612593473226, 48.0620398733737, 
 24.6778368458169, 29.4940756065979, 29.5255766630928, 12.2528941312156, 
 16.7534331385627, 44.1549766466566, 24.9720713007842, 26.5004734412987, 
 26.5319744977936, 44.7371886025741, 23.7251909886432, 24.0194254436104, 
 23.1265312136787, 20.3241203767039, 19.816294167944, 22.173885356505, 
 30.6899312504071, 35.537671067683, 32.5440689023839, 29.7372853932334, 
 57.523972527861)), .Names = c(".id", "corrected.gamma", "raw.gamma"
 ), row.names = c(NA, -79L), class = "data.frame")
  
  modules = matrix(c(rep(c(1, 0, 0), each = 5),
                     rep(c(0, 1, 0), each = 5),
                     rep(c(0, 0, 1), each = 5)), 15)
  cor.hypot = CreateHypotMatrix(modules)[[4]]
  hypot.mask = matrix(as.logical(cor.hypot), 15, 15)
  mod.cor = matrix(NA, 15, 15)
  set.seed(42)
  mod.cor[ hypot.mask] = runif(length(mod.cor[ hypot.mask]), 0.8, 0.9) # within-modules
  mod.cor[!hypot.mask] = runif(length(mod.cor[!hypot.mask]), 0.3, 0.4) # between-modules
  diag(mod.cor) = 1
  mod.cor = (mod.cor + t(mod.cor))/2 # correlation matrices should be symmetric
  hypothetical.modules = cbind(modules, matrix(sample(c(1, 0), 4*15, replace=TRUE), 15, 4))
  colnames(hypothetical.modules) <- letters[1:7]
  results = ModularityGamma(mod.cor, hypothetical.modules)
  expect_equal(results[[1]], expected)
  expect_true(all(results[[2]] == modules))
  
  set.seed(as.numeric(Sys.time()))
  random_var = runif(15, 1, 10)
  out = raply(50, function(x){
    mod.cov = cov(mvtnorm::rmvnorm(50, sigma = sqrt(outer(random_var, random_var)) * mod.cor))
    hypothetical.modules = cbind(modules, matrix(sample(c(1, 0), 4*15, replace=TRUE), 15, 4))
    results = ModularityGamma(mod.cov, hypothetical.modules)[[1]]
    return(results[1,1])})
  close_enough = sum(grepl("1_2_3|2_3|1_2|1_3", out, perl = TRUE))/50
  expect_true(close_enough > 0.90)
  
  xdata = mvtnorm::rmvnorm(200, sigma = sqrt(outer(random_var, random_var)) * mod.cor)
  out = JackKnifeModularityGamma(xdata, hypothetical.modules, 100)
  close_enough = sum(grepl("a_b_c", out, perl = TRUE))/100
  expect_true(close_enough > 0.95)
  
  expect_error(JackKnifeModularityGamma(xdata, hypothetical.modules[,1]))
  expect_error(JackKnifeModularityGamma(cov(xdata), hypothetical.modules))
})
